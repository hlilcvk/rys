services:
  postgres:
    image: postgres:15-alpine
    container_name: randevu-postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: SuperGucluSifre123Change
      POSTGRES_DB: randevu_master
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - randevu_network

  postgres_init:
    image: postgres:15-alpine
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGPASSWORD: SuperGucluSifre123Change
    command: >
      sh -c "
      sleep 5 &&
      psql -h postgres -U postgres -d randevu_master -c \"
      CREATE TABLE IF NOT EXISTS admin_users (
        id SERIAL PRIMARY KEY,
        isletme_id VARCHAR(50) NOT NULL UNIQUE,
        kullanici_adi VARCHAR(100) NOT NULL UNIQUE,
        ad_soyad VARCHAR(200) NOT NULL,
        sifre VARCHAR(255) NOT NULL,
        bagli_tablo_adi VARCHAR(100),
        db_host VARCHAR(255),
        db_port INTEGER,
        db_name VARCHAR(100),
        db_user VARCHAR(100),
        db_password VARCHAR(255),
        is_super_admin BOOLEAN DEFAULT false,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );
      INSERT INTO admin_users (isletme_id, kullanici_adi, ad_soyad, sifre, is_super_admin)
      VALUES ('SUPER', 'superadmin', 'Admin', '\$$2b\$$10\$$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW', true)
      ON CONFLICT DO NOTHING;
      \"
      "
    networks:
      - randevu_network

  backend:
    image: node:18-alpine
    container_name: randevu-backend
    restart: always
    depends_on:
      postgres_init:
        condition: service_completed_successfully
    working_dir: /app
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: randevu_master
      DB_USER: postgres
      DB_PASSWORD: SuperGucluSifre123Change
      JWT_SECRET: super-gizli-jwt-anahtar-2024-degistir
      PORT: 3000
    ports:
      - "3000:3000"
    command: >
      sh -c "
      cat > package.json << 'PKGEOF'
      {
        \"name\": \"randevu-backend\",
        \"version\": \"1.0.0\",
        \"main\": \"server.js\",
        \"dependencies\": {
          \"express\": \"^4.18.2\",
          \"pg\": \"^8.11.3\",
          \"jsonwebtoken\": \"^9.0.2\",
          \"bcrypt\": \"^5.1.1\",
          \"cors\": \"^2.8.5\"
        }
      }
      PKGEOF
      npm install &&
      cat > server.js << 'SRVEOF'
      const express = require('express');
      const cors = require('cors');
      const { Pool } = require('pg');
      const jwt = require('jsonwebtoken');
      const bcrypt = require('bcrypt');
      
      const app = express();
      app.use(cors());
      app.use(express.json());
      
      const pool = new Pool({
        host: process.env.DB_HOST,
        port: process.env.DB_PORT,
        database: process.env.DB_NAME,
        user: process.env.DB_USER,
        password: process.env.DB_PASSWORD
      });
      
      app.get('/health', (req, res) => {
        res.json({ status: 'OK', timestamp: new Date().toISOString() });
      });
      
      app.post('/api/auth/login', async (req, res) => {
        try {
          const { kullanici_adi, sifre } = req.body;
          const result = await pool.query('SELECT * FROM admin_users WHERE kullanici_adi = \$$1', [kullanici_adi]);
          
          if (result.rows.length === 0) {
            return res.status(401).json({ success: false, message: 'Kullanici bulunamadi' });
          }
          
          const user = result.rows[0];
          const isValid = await bcrypt.compare(sifre, user.sifre);
          
          if (!isValid) {
            return res.status(401).json({ success: false, message: 'Hatali sifre' });
          }
          
          const token = jwt.sign(
            { isletme_id: user.isletme_id, kullanici_adi: user.kullanici_adi },
            process.env.JWT_SECRET,
            { expiresIn: '8h' }
          );
          
          res.json({ 
            success: true, 
            token, 
            user: {
              isletme_id: user.isletme_id,
              kullanici_adi: user.kullanici_adi,
              ad_soyad: user.ad_soyad,
              is_super_admin: user.is_super_admin
            }
          });
        } catch (err) {
          console.error('Login error:', err);
          res.status(500).json({ success: false, message: 'Sunucu hatasi' });
        }
      });
      
      app.listen(3000, '0.0.0.0', () => console.log('Backend ready on :3000'));
      SRVEOF
      node server.js
      "
    networks:
      - randevu_network

  frontend:
    image: nginx:alpine
    container_name: randevu-frontend
    restart: always
    depends_on:
      - backend
    ports:
      - "80:80"
    command: >
      sh -c "
      cat > /usr/share/nginx/html/index.html << 'HTMLEOF'
      <!DOCTYPE html>
      <html lang=\"tr\">
      <head>
        <meta charset=\"UTF-8\">
        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
        <title>Randevu Yönetim Sistemi</title>
        <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">
        <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css\" rel=\"stylesheet\">
        <style>
          body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;font-family:system-ui}
          .login-card{background:#fff;padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:450px;width:100%}
          .login-header i{font-size:60px;color:#667eea;margin-bottom:15px}
          .form-control{padding:12px 20px;border-radius:10px;border:2px solid #e0e0e0}
          .form-control:focus{border-color:#667eea;box-shadow:0 0 0 .2rem rgba(102,126,234,.25)}
          .btn-login{width:100%;padding:14px;border-radius:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:#fff;font-weight:600;font-size:16px}
          .btn-login:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.3)}
          .input-group-text{background:#f8f9fa;border:2px solid #e0e0e0;border-right:none;border-radius:10px 0 0 10px}
          .input-group .form-control{border-left:none;border-radius:0 10px 10px 0}
        </style>
      </head>
      <body>
        <div class=\"login-card\">
          <div class=\"login-header text-center\">
            <i class=\"bi bi-calendar-check\"></i>
            <h2>Randevu Yönetim</h2>
            <p class=\"text-muted\">Giriş yaparak devam edin</p>
          </div>
          <div id=\"alert\"></div>
          <form id=\"loginForm\">
            <div class=\"mb-3\">
              <div class=\"input-group\">
                <span class=\"input-group-text\"><i class=\"bi bi-person\"></i></span>
                <input type=\"text\" class=\"form-control\" id=\"user\" placeholder=\"Kullanıcı Adı\" required>
              </div>
            </div>
            <div class=\"mb-4\">
              <div class=\"input-group\">
                <span class=\"input-group-text\"><i class=\"bi bi-lock\"></i></span>
                <input type=\"password\" class=\"form-control\" id=\"pass\" placeholder=\"Şifre\" required>
              </div>
            </div>
            <button type=\"submit\" class=\"btn btn-login\">Giriş Yap</button>
          </form>
          <div class=\"text-center mt-3\"><small class=\"text-muted\">Test: superadmin / Admin123!</small></div>
        </div>
        <script>
        const API=window.location.protocol+'//'+window.location.hostname+':3000';
        document.getElementById('loginForm').onsubmit=async e=>{
          e.preventDefault();
          try{
            const r=await fetch(API+'/api/auth/login',{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body:JSON.stringify({kullanici_adi:user.value,sifre:pass.value})
            });
            const d=await r.json();
            alert.innerHTML=d.success
              ?'<div class=\"alert alert-success\"><i class=\"bi bi-check-circle me-2\"></i>Giriş başarılı! Hoş geldiniz '+d.user.ad_soyad+'</div>'
              :'<div class=\"alert alert-danger\"><i class=\"bi bi-exclamation-circle me-2\"></i>'+d.message+'</div>';
            if(d.success){
              localStorage.setItem('token',d.token);
              localStorage.setItem('user',JSON.stringify(d.user));
            }
          }catch(e){
            alert.innerHTML='<div class=\"alert alert-danger\">Bağlantı hatası! Backend: '+API+'</div>';
          }
        };
        </script>
      </body>
      </html>
      HTMLEOF
      nginx -g 'daemon off;'
      "
    networks:
      - randevu_network

volumes:
  postgres_data:

networks:
  randevu_network:
    driver: bridge
